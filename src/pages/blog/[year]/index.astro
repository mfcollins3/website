---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import BlogPostCard from '../../../components/BlogPostCard.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog');
  const years = [...new Set(
    allPosts.map((p) => p.data.publishedDate.getFullYear())
  )];
  return years.map((year) => ({ params: { year: String(year) } }));
}

const { year } = Astro.params;
const yearNumber = Number(year);

const allPosts = await getCollection('blog');
const yearPosts = allPosts
  .filter((p) => p.data.publishedDate.getFullYear() === yearNumber)
  .sort((a, b) => b.data.publishedDate.getTime() - a.data.publishedDate.getTime());

const monthNames = [
  'January', 'February', 'March', 'April', 'May', 'June',
  'July', 'August', 'September', 'October', 'November', 'December',
];

const months = [...new Set(
  yearPosts.map((p) => p.data.publishedDate.getMonth())
)].sort((a, b) => b - a);
---

<BaseLayout
  title={`${year} | Blog | Michael F. Collins, III`}
  description={`Blog posts from ${year}`}
>
  <div class="min-h-screen bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
      <a
        href="/blog"
        class="inline-flex items-center gap-2 text-[#87ceeb] hover:text-[#87ceeb]/80 mb-8 transition-colors duration-200"
      >
        ‚Üê Back to Blog
      </a>

      <div class="flex flex-col lg:flex-row gap-8">
        <!-- Main Content -->
        <div class="lg:w-3/4">
          <h1 class="text-4xl font-bold text-gray-900 mb-8">Posts from {year}</h1>

          <div class="space-y-6">
            {yearPosts.length > 0 ? (
              yearPosts.map((post) => <BlogPostCard post={post} />)
            ) : (
              <p class="text-gray-600">No posts found for this year.</p>
            )}
          </div>
        </div>

        <!-- Sidebar -->
        <aside class="lg:w-1/4">
          <div class="bg-white rounded-lg shadow-md p-6 sticky top-24">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Months</h2>
            <ul class="space-y-2">
              {months.map((month) => {
                const monthPostCount = yearPosts.filter(
                  (p) => p.data.publishedDate.getMonth() === month
                ).length;
                const monthNum = String(month + 1).padStart(2, '0');
                return (
                  <li>
                    <a
                      href={`/blog/${year}/${monthNum}`}
                      class="text-gray-700 hover:text-[#87ceeb] transition-colors duration-200 flex items-center justify-between"
                    >
                      <span>{monthNames[month]}</span>
                      <span class="text-sm text-gray-500">({monthPostCount})</span>
                    </a>
                  </li>
                );
              })}
            </ul>
          </div>
        </aside>
      </div>
    </div>
  </div>
</BaseLayout>
